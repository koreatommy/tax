# 관리자 패널 - 사용자 관리 가이드

## 📋 개요

관리자 패널의 사용자 관리 페이지에서는 전체 사용자의 정보를 조회, 수정, 삭제할 수 있습니다.

---

## 🔐 접근 방법

1. **관리자 로그인**: http://localhost:3000/admin-login
2. **비밀번호**: `admin123` (환경 변수에서 변경 가능)
3. **사용자 관리**: http://localhost:3000/admin/users

---

## ✨ 주요 기능

### 1. 사용자 목록 조회

- 전체 사용자 목록 표시
- 각 사용자의 정보:
  - 이메일 주소
  - 회사명
  - 사업자등록번호
  - 가입일
  - 마지막 로그인 시간
  - 계정 상태

### 2. 사용자 상세보기 👁️

**기능**:
- 사용자의 모든 정보를 상세하게 확인
- 계정 정보 및 회사 정보 분리 표시

**표시 정보**:

**계정 정보**:
- 이메일
- 사용자 ID (UUID)
- 가입일시
- 마지막 로그인 일시

**회사 정보**:
- 회사명
- 사업자등록번호
- 대표자명
- 연락처
- 주소
- 회사 이메일

### 3. 사용자 정보 수정 ✏️

**기능**:
- 사용자의 회사 정보 수정
- 회사 정보가 없는 사용자에게 회사 정보 추가

**수정 가능한 필드**:
- ✅ 회사명 (필수)
- ✅ 사업자등록번호 (필수, 10자리)
- ✅ 대표자명 (필수)
- 연락처 (선택)
- 주소 (선택)
- 회사 이메일 (선택)

**동작**:
1. 수정 버튼 클릭
2. 모달 창에서 정보 입력/수정
3. 저장 버튼 클릭
4. 실시간 목록 업데이트

### 4. 사용자 삭제 🗑️

**기능**:
- 사용자 계정 영구 삭제
- 관련된 모든 데이터 함께 삭제

**삭제되는 데이터**:
- Auth 사용자 계정
- 회사 정보
- 지급 대상자 정보 (CASCADE)
- 지급 내역 (CASCADE)
- 영수증 발급 이력 (CASCADE)

**안전장치**:
- 삭제 확인 모달 표시
- 삭제할 사용자 정보 강조 표시
- 경고 메시지 표시

---

## 🔄 API 엔드포인트

### GET /api/admin/users
**설명**: 전체 사용자 목록 조회

**응답**:
```json
{
  "data": [
    {
      "id": "user-uuid",
      "email": "user@example.com",
      "created_at": "2024-10-04T12:00:00Z",
      "last_sign_in_at": "2024-10-04T16:00:00Z",
      "company": {
        "id": "company-uuid",
        "company_name": "테스트회사",
        "business_number": "1234567890",
        "representative_name": "홍길동",
        "address": "서울시...",
        "contact": "02-1234-5678",
        "email": "company@example.com"
      }
    }
  ]
}
```

### PUT /api/admin/users
**설명**: 사용자 회사 정보 수정

**요청 본문**:
```json
{
  "user_id": "user-uuid",
  "company_name": "수정된회사명",
  "business_number": "9876543210",
  "representative_name": "김철수",
  "address": "서울시...",
  "contact": "02-9876-5432",
  "email": "new@example.com"
}
```

**응답**:
```json
{
  "success": true,
  "message": "사용자 정보가 수정되었습니다"
}
```

### DELETE /api/admin/users?user_id=xxx
**설명**: 사용자 삭제

**응답**:
```json
{
  "success": true,
  "message": "사용자가 삭제되었습니다"
}
```

---

## 🎨 UI 컴포넌트

### 1. 테이블
- 반응형 디자인
- 정렬 및 필터링 가능
- 페이지네이션 (향후 추가 예정)

### 2. 모달
- **상세보기 모달**: 2열 그리드 레이아웃
- **수정 모달**: 입력 폼 (필수/선택 필드 구분)
- **삭제 확인 모달**: 경고 스타일

### 3. 버튼
- **👁️ 상세보기**: Ghost 버튼
- **✏️ 수정**: Ghost 버튼
- **🗑️ 삭제**: Ghost 버튼 (빨간색)
- **🔄 새로고침**: Outline 버튼

---

## 🔒 보안

### 관리자 권한 확인
모든 API 엔드포인트에서 `admin_session` 쿠키 확인:
```typescript
const adminSession = request.cookies.get('admin_session')
if (adminSession?.value !== 'authenticated') {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
```

### Service Role Key 사용
관리자 API는 RLS를 우회하는 Service Role Key 사용:
```typescript
const supabase = await createAdminClient()
```

---

## 📝 사용 예시

### 1. 회사 정보가 없는 사용자에게 정보 추가

1. 사용자 목록에서 회사명이 `-`인 사용자 확인
2. 수정 버튼 클릭
3. 회사 정보 입력:
   - 회사명: `(주)신규회사`
   - 사업자번호: `1234567890`
   - 대표자명: `홍길동`
4. 저장 클릭
5. 목록에서 회사 정보 확인

### 2. 사용자 삭제

1. 삭제할 사용자의 삭제 버튼 클릭
2. 확인 모달에서 사용자 정보 확인
3. "삭제" 버튼 클릭
4. 목록에서 사용자 제거 확인

---

## ⚠️ 주의사항

### 사용자 삭제 시
- **되돌릴 수 없습니다**: 삭제된 데이터는 복구 불가능
- **CASCADE 삭제**: 관련된 모든 데이터가 함께 삭제됨
- **신중하게 확인**: 삭제 전 반드시 사용자 정보 확인

### 사업자번호 수정 시
- **고유성**: 중복된 사업자번호 입력 시 오류 발생
- **10자리**: 반드시 10자리 숫자여야 함

---

## 🐛 문제 해결

### "Unauthorized" 오류
**원인**: 관리자 세션이 만료되었거나 없음  
**해결**: 관리자 로그인 페이지에서 다시 로그인

### 수정이 반영되지 않음
**원인**: 캐시 또는 세션 문제  
**해결**: 새로고침 버튼 클릭 또는 페이지 새로고침

### 사용자 목록이 비어있음
**원인**: 
1. 실제로 사용자가 없음
2. API 연결 문제
3. Service Role Key 설정 오류

**해결**:
1. 일반 회원가입 페이지에서 사용자 생성
2. `.env.local`에서 `SUPABASE_SERVICE_ROLE_KEY` 확인
3. 브라우저 콘솔에서 오류 메시지 확인

---

## 🔮 향후 개선 사항

- [ ] 검색 기능 추가
- [ ] 필터링 (회사 유무, 가입 기간 등)
- [ ] 페이지네이션
- [ ] 일괄 작업 (선택한 사용자 일괄 삭제)
- [ ] 사용자 활동 로그 조회
- [ ] 사용자 계정 정지/복원 기능
- [ ] 엑셀 내보내기

---

**작성일**: 2025-10-04  
**버전**: 1.0.0

